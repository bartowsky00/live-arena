---
import Layout from '../../layouts/Layout.astro';
import { getAllEvents } from '../../lib/events';

export async function getStaticPaths() {
  const events = await getAllEvents();
  return events.map(event => ({
    params: { slug: event.slug },
    props: { event }
  }));
}

const { event } = Astro.props;

// Verifica se l'evento è passato (basandosi sulla data)
const eventDate = new Date(event.dateEnd || event.date);
const today = new Date();
const isPastEvent = eventDate < today || event.status === 'past';

const statusLabels = {
  'on-sale': 'In Vendita',
  'coming-soon': 'Coming Soon',
  'sold-out': 'Sold Out',
  'past': 'Evento Passato'
};

const statusColors = {
  'on-sale': 'bg-green-500',
  'coming-soon': 'bg-amber-500',
  'sold-out': 'bg-arena-red',
  'past': 'bg-white/20'
};

// Venue info
const venue = event.venue || {
  name: 'Live Arena',
  slug: 'live-arena',
  shortName: 'live-arena',
  address: 'Via Esa Chimento, 92100 Agrigento AG',
  isIndoor: false
};

const venuePageUrl = venue.shortName === 'palaforum' ? '/palaforum' : '/live-arena';
const venueColor = 'arena-red';
---

<Layout title={event.artist} description={event.description}>
  <!-- Hero Section -->
  <section class="relative min-h-[70vh] flex items-end overflow-hidden">
    <!-- Background Image -->
    <div class="absolute inset-0">
      <img
        src={event.image}
        alt={event.artist}
        class="w-full h-full object-cover"
      />
      <div class="absolute inset-0 bg-gradient-to-t from-arena-black via-arena-black/80 to-arena-black/30"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-arena-black/50 to-transparent"></div>
    </div>

    <!-- Content -->
    <div class="relative z-10 max-w-7xl mx-auto px-6 py-16 w-full">
      <!-- Back Link -->
      <a href={`${venuePageUrl}/eventi`} class="inline-flex items-center gap-2 text-white/60 hover:text-white mb-8 transition-colors">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span>Eventi {venue.name}</span>
      </a>

      <!-- Badges -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <!-- Status Badge -->
        <span class={`inline-block px-4 py-2 text-sm uppercase tracking-wider font-medium text-white ${isPastEvent ? 'bg-white/20' : statusColors[event.status]}`}>
          {isPastEvent ? 'Evento Passato' : statusLabels[event.status]}
        </span>
        <!-- Venue Badge -->
        <a
          href={venuePageUrl}
          class={`inline-block px-4 py-2 text-sm uppercase tracking-wider font-medium text-white ${'bg-arena-red hover:bg-arena-red-glow'} transition-colors`}
        >
          {venue.name}
        </a>
      </div>

      <!-- Date -->
      <div class="flex items-center gap-3 mb-4">
        <div class={`w-12 h-px bg-arena-red`}></div>
        <span class={`${'text-arena-red'} text-xl font-medium tracking-wider uppercase`}>{event.dateDisplay}</span>
      </div>

      <!-- Artist Name -->
      <h1 class="font-display text-5xl sm:text-7xl md:text-8xl tracking-wider text-white mb-4">
        {event.artist}
      </h1>

      <!-- Tour Name -->
      {event.tour && (
        <p class="text-2xl text-white/70 mb-8">{event.tour}</p>
      )}
    </div>
  </section>

  <!-- Content Section -->
  <section class="py-16 md:py-24 bg-arena-black">
    <div class="max-w-7xl mx-auto px-6">
      <div class="grid lg:grid-cols-3 gap-12">
        <!-- Main Content -->
        <div class="lg:col-span-2">
          <h2 class="font-display text-3xl tracking-wider text-white mb-6">L'EVENTO</h2>
          <p class="text-white/70 text-lg leading-relaxed mb-8">
            {event.description}
          </p>

          <!-- Event Details -->
          <div class="grid sm:grid-cols-2 gap-6 mt-12">
            <div class="p-6 bg-arena-gray border border-white/5">
              <div class="flex items-center gap-4 mb-4">
                <div class={`w-12 h-12 ${'bg-arena-red/10'} flex items-center justify-center`}>
                  <svg class={`w-6 h-6 ${'text-arena-red'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-white/50 text-sm uppercase tracking-wider">Data</p>
                  <p class="text-white font-medium">{event.dateDisplay}</p>
                </div>
              </div>
            </div>

            <div class="p-6 bg-arena-gray border border-white/5">
              <div class="flex items-center gap-4 mb-4">
                <div class={`w-12 h-12 ${'bg-arena-red/10'} flex items-center justify-center`}>
                  <svg class={`w-6 h-6 ${'text-arena-red'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                  </svg>
                </div>
                <div>
                  <p class="text-white/50 text-sm uppercase tracking-wider">Location</p>
                  <a href={venuePageUrl} class={`text-white font-medium hover:${'text-arena-red'} transition-colors`}>
                    {venue.name}
                  </a>
                  <p class="text-white/50 text-sm">{venue.address}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Venue Info Card -->
          <div class={`mt-8 p-6 border ${'border-arena-red/20 bg-arena-red/5'}`}>
            <div class="flex items-start gap-4">
              <div class={`w-12 h-12 ${'bg-arena-red/20'} flex items-center justify-center flex-shrink-0`}>
                {venue.isIndoor ? (
                  <svg class={`w-6 h-6 ${'text-arena-red'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                  </svg>
                ) : (
                  <svg class={`w-6 h-6 ${'text-arena-red'}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                )}
              </div>
              <div class="flex-1">
                <h4 class="font-display text-lg tracking-wider text-white mb-2">
                  {venue.name}
                </h4>
                <p class="text-white/60 text-sm mb-3">
                  {venue.isIndoor
                    ? 'Struttura al coperto con climatizzazione. Eventi tutto l\'anno.'
                    : 'Location all\'aperto. Eventi durante la stagione estiva.'}
                </p>
                <a
                  href={venuePageUrl}
                  class={`inline-flex items-center gap-2 text-sm ${'text-arena-red hover:text-arena-red-glow'} transition-colors`}
                >
                  <span>Scopri la venue</span>
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </div>

        <!-- Sidebar - Tickets -->
        <div class="lg:col-span-1">
          <div class="sticky top-24 p-8 bg-arena-gray border border-white/5">
            <h3 class="font-display text-2xl tracking-wider text-white mb-6">BIGLIETTI</h3>

            {isPastEvent ? (
              <div class="text-center">
                <div class="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-4">
                  <svg class="w-8 h-8 text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                <p class="text-white/50">Questo evento si è già svolto.</p>
                <a href={`${venuePageUrl}/eventi`} class={`inline-block mt-4 ${'text-arena-red hover:text-arena-red-glow'} text-sm`}>
                  Scopri i prossimi eventi →
                </a>
              </div>
            ) : event.status === 'sold-out' ? (
              <div class="text-center">
                <p class="text-arena-red font-medium text-lg mb-2">Sold Out!</p>
                <p class="text-white/50 text-sm">I biglietti per questo evento sono esauriti.</p>
              </div>
            ) : (
              <>
                {/* Prices */}
                {event.prices && event.prices.length > 0 && (
                  <div class="mb-8">
                    <p class="text-white/50 text-sm uppercase tracking-wider mb-4">Prezzi</p>
                    <ul class="space-y-3">
                      {event.prices.map((price: {type: string, price: number}) => (
                        <li class="flex justify-between items-center">
                          <span class="text-white/70">{price.type}</span>
                          <span class="text-white font-medium">€{price.price.toFixed(2)}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* Ticket Buttons */}
                <div class="space-y-4">
                  {event.ticketOne && (
                    <a
                      href={event.ticketOne}
                      target="_blank"
                      rel="noopener"
                      class={`block w-full py-4 ${'bg-arena-red hover:bg-arena-red-glow'} text-white text-center font-medium tracking-wider uppercase transition-colors`}
                    >
                      Acquista su TicketOne
                    </a>
                  )}
                  {event.ticketZeta && (
                    <a
                      href={event.ticketZeta}
                      target="_blank"
                      rel="noopener"
                      class="block w-full py-4 bg-white/10 hover:bg-white/20 text-white text-center font-medium tracking-wider uppercase transition-colors"
                    >
                      Acquista su TicketZeta
                    </a>
                  )}
                </div>

                {event.status === 'coming-soon' && (
                  <p class="text-amber-500 text-sm mt-4 text-center">Biglietti in vendita a breve</p>
                )}
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Gallery Section (solo per eventi con foto) -->
  {event.gallery && event.gallery.length > 0 && (
    <section class="py-16 md:py-24 bg-arena-dark">
      <div class="max-w-7xl mx-auto px-6">
        <h2 class="font-display text-3xl tracking-wider text-white mb-8">FOTOGALLERY</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          {event.gallery.map((photo: { url: string; caption?: string }, index: number) => (
            <button
              class="group relative aspect-square overflow-hidden cursor-pointer gallery-item"
              data-index={index}
              data-url={photo.url}
              data-caption={photo.caption || ''}
            >
              <img
                src={photo.url}
                alt={photo.caption || `${event.artist} - Foto ${index + 1}`}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
              />
              <div class="absolute inset-0 bg-arena-black/0 group-hover:bg-arena-black/40 transition-colors duration-300 flex items-center justify-center">
                <svg class="w-10 h-10 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
                </svg>
              </div>
            </button>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Lightbox -->
  <div id="lightbox" class="fixed inset-0 z-[200] bg-arena-black/95 hidden items-center justify-center">
    <button id="lightbox-close" class="absolute top-6 right-6 text-white/70 hover:text-white z-10">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <button id="lightbox-prev" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-10 p-2">
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    <button id="lightbox-next" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/70 hover:text-white z-10 p-2">
      <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
      </svg>
    </button>
    <div class="max-w-5xl max-h-[90vh] px-4">
      <img id="lightbox-img" src="" alt="" class="max-w-full max-h-[85vh] object-contain" />
      <p id="lightbox-caption" class="text-white/70 text-center mt-4"></p>
    </div>
  </div>

  <!-- Map Section -->
  <section class="py-16 bg-arena-black">
    <div class="max-w-7xl mx-auto px-6">
      <h2 class="font-display text-3xl tracking-wider text-white mb-8">COME ARRIVARE</h2>
      <div class="aspect-[21/9] bg-arena-gray relative overflow-hidden">
        <iframe
          src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3173.8!2d13.57!3d37.31!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x0%3A0x0!2sVia+Esa+Chimento%2C+92100+Agrigento+AG!5e0!3m2!1sit!2sit!4v1"
          width="100%"
          height="100%"
          style="border:0; filter: grayscale(100%) invert(92%) contrast(83%);"
          allowfullscreen
          loading="lazy"
          referrerpolicy="no-referrer-when-downgrade"
          title={`Mappa ${venue.name}`}
        ></iframe>
        <div class={`absolute inset-0 border ${'border-arena-red/20'} pointer-events-none`}></div>
      </div>
    </div>
  </section>

  <!-- Other Events -->
  <section class="py-16 md:py-24 bg-arena-dark">
    <div class="max-w-7xl mx-auto px-6">
      <h2 class="font-display text-3xl tracking-wider text-white mb-8">ALTRI EVENTI</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <a
          href={`${venuePageUrl}/eventi`}
          class={`inline-flex items-center gap-3 ${'text-arena-red hover:text-arena-red-glow'} transition-colors group`}
        >
          <span class="tracking-wider uppercase font-medium">Eventi {venue.name}</span>
          <svg class="w-5 h-5 transform group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </a>
        <a
          href="/"
          class="inline-flex items-center gap-3 text-white/70 hover:text-white transition-colors group"
        >
          <span class="tracking-wider uppercase font-medium">Tutti gli eventi</span>
          <svg class="w-5 h-5 transform group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </a>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Lightbox functionality
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
  const lightboxCaption = document.getElementById('lightbox-caption');
  const lightboxClose = document.getElementById('lightbox-close');
  const lightboxPrev = document.getElementById('lightbox-prev');
  const lightboxNext = document.getElementById('lightbox-next');
  const galleryItems = document.querySelectorAll('.gallery-item');

  let currentIndex = 0;
  const photos: { url: string; caption: string }[] = [];

  // Collect all photos
  galleryItems.forEach((item, index) => {
    const url = item.getAttribute('data-url') || '';
    const caption = item.getAttribute('data-caption') || '';
    photos.push({ url, caption });

    item.addEventListener('click', () => {
      currentIndex = index;
      openLightbox();
    });
  });

  function openLightbox() {
    if (!lightbox || !lightboxImg || !lightboxCaption) return;
    lightboxImg.src = photos[currentIndex].url;
    lightboxCaption.textContent = photos[currentIndex].caption;
    lightbox.classList.remove('hidden');
    lightbox.classList.add('flex');
    document.body.style.overflow = 'hidden';
  }

  function closeLightbox() {
    if (!lightbox) return;
    lightbox.classList.add('hidden');
    lightbox.classList.remove('flex');
    document.body.style.overflow = '';
  }

  function showPrev() {
    currentIndex = (currentIndex - 1 + photos.length) % photos.length;
    if (lightboxImg && lightboxCaption) {
      lightboxImg.src = photos[currentIndex].url;
      lightboxCaption.textContent = photos[currentIndex].caption;
    }
  }

  function showNext() {
    currentIndex = (currentIndex + 1) % photos.length;
    if (lightboxImg && lightboxCaption) {
      lightboxImg.src = photos[currentIndex].url;
      lightboxCaption.textContent = photos[currentIndex].caption;
    }
  }

  lightboxClose?.addEventListener('click', closeLightbox);
  lightboxPrev?.addEventListener('click', showPrev);
  lightboxNext?.addEventListener('click', showNext);

  // Close on background click
  lightbox?.addEventListener('click', (e) => {
    if (e.target === lightbox) closeLightbox();
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (lightbox?.classList.contains('hidden')) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowLeft') showPrev();
    if (e.key === 'ArrowRight') showNext();
  });
</script>
